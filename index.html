import React, { useState, useEffect } from 'react';
import { Tab } from '@/components/ui/tabs';
import { Alert, AlertDescription } from '@/components/ui/alert';
import Papa from 'papaparse';
import * as XLSX from 'xlsx';
import _ from 'lodash';

const MatchApp = () => {
  // State for file and data
  const [file, setFile] = useState(null);
  const [manualMode, setManualMode] = useState(false);
  const [activeTab, setActiveTab] = useState('azelis');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [results, setResults] = useState([]);
  
  // State for manual data entry
  const [azelisData, setAzelisData] = useState([{ 'Azelis Code': '', 'Description': '' }]);
  const [supplierData, setSupplierData] = useState([{ 
    'Supplier Description': '', 'SKU': '', 'Weight': '', 
    'Price': '', 'From': '', 'To': '' 
  }]);
  const [logisticData, setLogisticData] = useState([{
    'Logistic From': '', 'Logistic To': '', 'Additional Charge': ''
  }]);
  const [packweightData, setPackweightData] = useState([{
    'Pack From': '', 'Pack To': '', 'Additional Charge': ''
  }]);

  // Handle file upload
  const handleFileChange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    setLoading(true);
    setError('');
    
    try {
      const buffer = await file.arrayBuffer();
      const workbook = XLSX.read(buffer, {
        cellDates: true,
        cellNF: true,
        cellStyles: true
      });

      const sheets = {};
      ['Azelis', 'Supplier', 'Logistic', 'PackWeight'].forEach(name => {
        if (workbook.SheetNames.includes(name)) {
          sheets[name] = XLSX.utils.sheet_to_json(workbook.Sheets[name]);
        }
      });

      processData(sheets);
    } catch (err) {
      setError('Error processing file: ' + err.message);
    } finally {
      setLoading(false);
    }
  };

  // Process data from either file or manual entry
  const processData = (data) => {
    // Implementation of your Python processing logic
    // This would need to be adapted from the Python code
    // For now, just displaying the raw data
    setResults(data.Azelis || []);
  };

  // Handle manual data processing
  const handleManualProcess = () => {
    const data = {
      Azelis: azelisData.filter(row => row['Azelis Code'] || row['Description']),
      Supplier: supplierData.filter(row => Object.values(row).some(v => v)),
      Logistic: logisticData.filter(row => Object.values(row).some(v => v)),
      PackWeight: packweightData.filter(row => Object.values(row).some(v => v))
    };
    processData(data);
  };

  // Add row to respective table
  const addRow = (tableType) => {
    switch (tableType) {
      case 'azelis':
        setAzelisData([...azelisData, { 'Azelis Code': '', 'Description': '' }]);
        break;
      case 'supplier':
        setSupplierData([...supplierData, {
          'Supplier Description': '', 'SKU': '', 'Weight': '',
          'Price': '', 'From': '', 'To': ''
        }]);
        break;
      case 'logistic':
        setLogisticData([...logisticData, {
          'Logistic From': '', 'Logistic To': '', 'Additional Charge': ''
        }]);
        break;
      case 'packweight':
        setPackweightData([...packweightData, {
          'Pack From': '', 'Pack To': '', 'Additional Charge': ''
        }]);
        break;
    }
  };

  // Export results to Excel
  const exportToExcel = () => {
    if (results.length === 0) return;
    
    const ws = XLSX.utils.json_to_sheet(results);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Results");
    XLSX.writeFile(wb, "match_results.xlsx");
  };

  // Reset all data
  const resetAll = () => {
    setFile(null);
    setManualMode(false);
    setActiveTab('azelis');
    setResults([]);
    setError('');
    setAzelisData([{ 'Azelis Code': '', 'Description': '' }]);
    setSupplierData([{ 
      'Supplier Description': '', 'SKU': '', 'Weight': '',
      'Price': '', 'From': '', 'To': ''
    }]);
    setLogisticData([{
      'Logistic From': '', 'Logistic To': '', 'Additional Charge': ''
    }]);
    setPackweightData([{
      'Pack From': '', 'Pack To': '', 'Additional Charge': ''
    }]);
  };

  return (
    <div className="container mx-auto p-4">
      <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h1 className="text-2xl font-bold mb-4">Match App</h1>
        
        <div className="flex gap-4 mb-4">
          <div className="flex-1">
            <input
              type="file"
              accept=".xlsx"
              onChange={handleFileChange}
              className="block w-full text-sm text-gray-500 
                       file:mr-4 file:py-2 file:px-4 
                       file:rounded-full file:border-0 
                       file:text-sm file:font-semibold 
                       file:bg-blue-50 file:text-blue-700 
                       hover:file:bg-blue-100"
            />
          </div>
          <button
            onClick={() => setManualMode(!manualMode)}
            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
          >
            {manualMode ? 'Switch to File Upload' : 'Enter Data Manually'}
          </button>
          <button
            onClick={exportToExcel}
            disabled={results.length === 0}
            className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 
                     disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Export to Excel
          </button>
          <button
            onClick={resetAll}
            className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
          >
            Reset
          </button>
        </div>

        {loading && (
          <div className="text-center">
            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
            Processing...
          </div>
        )}

        {error && (
          <Alert variant="destructive" className="mb-4">
            <AlertDescription>{error}</AlertDescription>
          </Alert>
        )}

        {manualMode && (
          <div className="mb-4">
            <div className="border-b border-gray-200">
              <nav className="-mb-px flex space-x-8">
                {['azelis', 'supplier', 'logistic', 'packweight'].map((tab) => (
                  <button
                    key={tab}
                    onClick={() => setActiveTab(tab)}
                    className={`tab-button border-b-2 px-1 py-4 text-sm font-medium
                              ${activeTab === tab 
                                ? 'border-blue-500 text-blue-600' 
                                : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700'
                              }`}
                  >
                    {tab.charAt(0).toUpperCase() + tab.slice(1)} Data
                  </button>
                ))}
              </nav>
            </div>

            <div className="mt-4">
              {/* Table components would go here */}
              {/* For brevity, I'm just showing a placeholder */}
              <div className="text-center p-4 text-gray-500">
                Table interface for {activeTab} would go here
              </div>
              
              <button
                onClick={() => addRow(activeTab)}
                className="mt-2 px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600"
              >
                Add Row
              </button>
            </div>

            <button
              onClick={handleManualProcess}
              className="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
            >
              Process Manual Data
            </button>
          </div>
        )}

        {results.length > 0 && (
          <div className="mt-4 overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  {Object.keys(results[0]).map((header) => (
                    <th
                      key={header}
                      className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      {header}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {results.map((row, idx) => (
                  <tr key={idx}>
                    {Object.values(row).map((value, i) => (
                      <td key={i} className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {value}
                      </td>
                    ))}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
      
      <div className="text-sm text-gray-500">Created by Greg Michell</div>
    </div>
  );
};

export default MatchApp;

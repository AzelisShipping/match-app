import React, { useState } from 'react';
import { Tab } from '@/components/ui/tabs';
import { Alert, AlertDescription } from '@/components/ui/alert';

const EditableTable = ({ columns, data, setData }) => {
  const handlePaste = (e, rowIndex, colIndex) => {
    e.preventDefault();
    const pastedText = e.clipboardData.getData('text');
    const rows = pastedText.split(/\r\n|\n|\r/).filter(row => row.trim());
    
    // Split each row by tabs or multiple spaces
    const pastedData = rows.map(row => row.split(/\t|\s{2,}/));
    
    // Update data with pasted content
    setData(currentData => {
      const newData = [...currentData];
      pastedData.forEach((row, i) => {
        const dataRowIndex = rowIndex + i;
        // Create new rows if needed
        while (newData.length <= dataRowIndex) {
          const emptyRow = {};
          columns.forEach(col => emptyRow[col.key] = '');
          newData.push(emptyRow);
        }
        
        row.forEach((cell, j) => {
          const colKey = columns[colIndex + j]?.key;
          if (colKey) {
            newData[dataRowIndex][colKey] = cell.trim();
          }
        });
      });
      return newData;
    });
  };

  const handleCellChange = (rowIndex, column, value) => {
    setData(currentData => {
      const newData = [...currentData];
      newData[rowIndex] = { ...newData[rowIndex], [column.key]: value };
      return newData;
    });
  };

  return (
    <div className="border rounded" style={{ height: '600px' }}>
      <div className="overflow-auto h-full">
        <table className="w-full table-fixed bg-white">
          <thead className="sticky top-0 bg-gray-50 z-10">
            <tr>
              {columns.map((column) => (
                <th 
                  key={column.key}
                  className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-r"
                  style={{ width: column.key === 'Description' || column.key === 'Supplier Description' ? '300px' : '150px' }}
                >
                  {column.label}
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {data.map((row, rowIndex) => (
              <tr key={rowIndex} className="border-b hover:bg-gray-50">
                {columns.map((column, colIndex) => (
                  <td key={column.key} className="border-r p-0">
                    <input
                      type="text"
                      value={row[column.key] || ''}
                      onChange={(e) => handleCellChange(rowIndex, column, e.target.value)}
                      onPaste={(e) => handlePaste(e, rowIndex, colIndex)}
                      className="w-full h-8 px-3 border-0 focus:ring-1 focus:ring-blue-500 focus:ring-opacity-50 focus:outline-none"
                    />
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};

const MatchApp = () => {
  // State for each table's data
  const [activeTab, setActiveTab] = useState('azelis');
  const [error, setError] = useState('');
  const [results, setResults] = useState([]);
  
  // Create array of 1000 empty rows for each table
  const createEmptyRows = (template, count = 1000) => 
    Array(count).fill().map(() => ({...template}));

  const [azelisData, setAzelisData] = useState(createEmptyRows({ 
    'Azelis Code': '', 'Description': '' 
  }));
  
  const [supplierData, setSupplierData] = useState(createEmptyRows({
    'Supplier Description': '', 'SKU': '', 'Weight': '', 
    'Price': '', 'From': '', 'To': ''
  }));
  
  const [logisticData, setLogisticData] = useState(createEmptyRows({
    'Logistic From': '', 'Logistic To': '', 'Additional Charge': ''
  }));
  
  const [packweightData, setPackweightData] = useState(createEmptyRows({
    'Pack From': '', 'Pack To': '', 'Additional Charge': ''
  }));

  // Table column definitions
  const tableDefinitions = {
    azelis: {
      columns: [
        { key: 'Azelis Code', label: 'Azelis Code' },
        { key: 'Description', label: 'Description' }
      ]
    },
    supplier: {
      columns: [
        { key: 'Supplier Description', label: 'Supplier Description' },
        { key: 'SKU', label: 'SKU' },
        { key: 'Weight', label: 'Weight' },
        { key: 'Price', label: 'Price' },
        { key: 'From', label: 'From' },
        { key: 'To', label: 'To' }
      ]
    },
    logistic: {
      columns: [
        { key: 'Logistic From', label: 'Logistic From' },
        { key: 'Logistic To', label: 'Logistic To' },
        { key: 'Additional Charge', label: 'Additional Charge' }
      ]
    },
    packweight: {
      columns: [
        { key: 'Pack From', label: 'Pack From' },
        { key: 'Pack To', label: 'Pack To' },
        { key: 'Additional Charge', label: 'Additional Charge' }
      ]
    }
  };

  // Add empty row to current table
  const addRow = () => {
    const emptyRow = {};
    tableDefinitions[activeTab].columns.forEach(col => emptyRow[col.key] = '');
    
    switch (activeTab) {
      case 'azelis':
        setAzelisData([...azelisData, emptyRow]);
        break;
      case 'supplier':
        setSupplierData([...supplierData, emptyRow]);
        break;
      case 'logistic':
        setLogisticData([...logisticData, emptyRow]);
        break;
      case 'packweight':
        setPackweightData([...packweightData, emptyRow]);
        break;
    }
  };

  // Process the data
  const processData = () => {
    try {
      // Filter out empty rows
      const cleanAzelisData = azelisData.filter(row => 
        Object.values(row).some(val => val.trim() !== ''));
      const cleanSupplierData = supplierData.filter(row => 
        Object.values(row).some(val => val.trim() !== ''));
      const cleanLogisticData = logisticData.filter(row => 
        Object.values(row).some(val => val.trim() !== ''));
      const cleanPackweightData = packweightData.filter(row => 
        Object.values(row).some(val => val.trim() !== ''));

      // TODO: Implement your matching logic here
      // For now, just showing the Azelis data as results
      setResults(cleanAzelisData);
      setError('');
    } catch (err) {
      setError('Error processing data: ' + err.message);
    }
  };

  // Export results to Excel
  const exportResults = () => {
    if (results.length === 0) return;
    
    const ws = XLSX.utils.json_to_sheet(results);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Results");
    XLSX.writeFile(wb, "match_results.xlsx");
  };

  // Reset all data
  const resetAll = () => {
    setAzelisData(createEmptyRows({ 'Azelis Code': '', 'Description': '' }));
    setSupplierData(createEmptyRows({
      'Supplier Description': '', 'SKU': '', 'Weight': '',
      'Price': '', 'From': '', 'To': ''
    }));
    setLogisticData(createEmptyRows({
      'Logistic From': '', 'Logistic To': '', 'Additional Charge': ''
    }));
    setPackweightData(createEmptyRows({
      'Pack From': '', 'Pack To': '', 'Additional Charge': ''
    }));
    setResults([]);
    setError('');
  };

  const getCurrentTableData = () => {
    switch (activeTab) {
      case 'azelis': return { data: azelisData, setData: setAzelisData };
      case 'supplier': return { data: supplierData, setData: setSupplierData };
      case 'logistic': return { data: logisticData, setData: setLogisticData };
      case 'packweight': return { data: packweightData, setData: setPackweightData };
    }
  };

  return (
    <div className="max-w-full p-4">
      <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
        <h1 className="text-2xl font-bold mb-4">Match App</h1>
        
        <div className="flex gap-4 mb-4">
          <button
            onClick={processData}
            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
          >
            Process Data
          </button>
          <button
            onClick={exportResults}
            disabled={results.length === 0}
            className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 
                     disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Export Results
          </button>
          <button
            onClick={resetAll}
            className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
          >
            Reset
          </button>
        </div>

        {error && (
          <Alert variant="destructive" className="mb-4">
            <AlertDescription>{error}</AlertDescription>
          </Alert>
        )}

        <div className="mb-4">
          <div className="border-b border-gray-200">
            <nav className="-mb-px flex space-x-8">
              {Object.keys(tableDefinitions).map((tab) => (
                <button
                  key={tab}
                  onClick={() => setActiveTab(tab)}
                  className={`tab-button border-b-2 px-1 py-4 text-sm font-medium
                            ${activeTab === tab 
                              ? 'border-blue-500 text-blue-600' 
                              : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700'
                            }`}
                >
                  {tab.charAt(0).toUpperCase() + tab.slice(1)} Data
                </button>
              ))}
            </nav>
          </div>

          <div className="mt-4">
            <div className="mb-2 text-sm text-gray-600">
              Tip: You can paste data directly from Excel. Select the cell where you want to start pasting.
            </div>
            
            <EditableTable 
              columns={tableDefinitions[activeTab].columns}
              {...getCurrentTableData()}
            />
            

          </div>
        </div>

        {results.length > 0 && (
          <div className="mt-4 overflow-x-auto">
            <h2 className="text-xl font-bold mb-2">Results</h2>
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  {Object.keys(results[0]).map((header) => (
                    <th
                      key={header}
                      className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      {header}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {results.map((row, idx) => (
                  <tr key={idx}>
                    {Object.values(row).map((value, i) => (
                      <td key={i} className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {value}
                      </td>
                    ))}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
      
      <div className="text-sm text-gray-500">Created by Greg Michell</div>
    </div>
  );
};

export default MatchApp;
